# SPEC.md 审计报告（2026-02-04-a）

- 审计对象：`SPEC.md`（文档版本：**2026-02-04-a**）
- 审计日期：2026-02-04
- 审计范围（本次增量重点）：
  - F5「快速添加 Todo」、F6「移动任务日期」、共享组件「DatePickerModal」
  - 与上述功能相关的配置项/测试计划/合规声明
  - **移动端适配**（iOS/Android 可用性、交互等价性、UI 约束）

## 结论摘要

F5/F6/DatePicker 的核心流程描述基本完整，但当前规格书在“写入合规边界”“移动端交互等价性”“回滚/一致性保证”“配置闭环与测试覆盖”方面存在缺口。其中 **P0 级问题会直接造成验收口径与用户预期冲突**，建议在进入 v1.3.0 实现前先修订规格书。

## 严重级别定义

- **P0**：阻塞验收/发布叙事；或造成重大误解（合规、数据安全、行为语义）
- **P1**：重要可实现性/一致性问题；不修易导致缺陷或移动端不可用
- **P2**：改进项；提升可用性/可测性/可维护性

## 发现清单（重点：移动端适配）

### P0-1 合规声明与 F5/F6 写入行为冲突

- 证据：
  - 规格书声明“有限写入：仅 F4 功能会追加内容到 Daily Note（用户主动触发）”。`SPEC.md:1130`
  - F5 明确“写入对应日期的 Daily Note”。`SPEC.md:97`
  - F6 明确“从原文件删除任务行，追加到目标文件”。`SPEC.md:116`
- 影响：
  - 对外说明/审核口径不一致；用户对“是否修改笔记内容”的预期会被误导。
  - 若后续实现按 F5/F6 写入，当前合规章节不成立。
- 建议：
  - 在 §6.3 明确写入边界：F4/F5/F6 均会在用户触发下写入/修改；说明写入触发条件、写入位置、失败策略、是否支持撤销（至少手工回滚说明）。

### P0-2 F6 “移动失败回滚”语义不闭环（存在重复/半成功风险）

- 证据：
  - 规格书写“移动失败时回滚（不删除原任务）”。`SPEC.md:136`
  - 但同页给出的移动实现示例流程是“先写目标，再删源”。`SPEC.md:821`
- 风险场景：
  - 目标写入成功后，源文件删除失败（权限/并发/冲突），会导致任务重复（目标与原处同时存在），与“移动”语义冲突。
- 建议：
  - 在规格书补齐一致性策略（至少一条可验收）：
    - **补偿事务**：若源删除失败，尝试从目标撤销写入；若撤销也失败，则提示“检测到重复，需人工处理”并给出两个文件路径。
    - 或 **标记策略**：先在源任务行打标（如 `⏳moving`），确认目标写入成功后再删除；任一步失败都可恢复到一致状态。
  - 将“回滚”定义覆盖到“目标成功但源失败”的情况，并补充对应测试用例（含移动端）。

### P1-1 F6 右键菜单在移动端无等价交互定义

- 证据：
  - F6 触发方式之一是“右键菜单「移动到...」”。`SPEC.md:121`
  - 规格书未定义移动端等价交互（移动端无右键）。
- 影响：
  - 规格书虽声明支持移动端，但该入口在移动端不可用，会造成 UX 断层与验收争议。
- 建议：
  - 将“右键菜单”明确为**桌面端专有入口**；移动端主入口建议固定为“任务项右侧 📅 按钮”（并明确其可点击区域/位置）。
  - 如仍需要“菜单式入口”，建议定义“长按任务项弹出菜单（移动到/取消）”作为等价方案，并写入 7.4 移动端验收项。

### P1-2 F5 快捷键在移动端不可达，需定义移动端主流程

- 证据：
  - F5 定义 `Ctrl/Cmd + Enter` 快速添加到今天。`SPEC.md:112`
  - 测试用例写 `Ctrl+Enter`。`SPEC.md:1156`
- 影响：
  - 移动端键盘/快捷键不可用或不稳定；若无按钮等价路径，移动端会出现“无法快速添加到今天”的体验缺口。
- 建议：
  - 明确：快捷键仅桌面端；移动端主路径为“📅 今天”按钮/“添加到今天”按钮。
  - 测试用例拆分为“桌面快捷键”与“移动端按钮路径”，避免混用。

### P1-3 DatePickerModal 缺少移动端 UI/交互约束（易出现可用性问题）

- 证据：
  - DatePicker 设计包含“快捷按钮 + 日历网格 + 输入框”。`SPEC.md:141`
  - 移动端章节仅写“需测试 iOS/Android Modal 显示效果”。`SPEC.md:1184`
- 影响（常见移动端问题）：
  - 日历格子/箭头按钮触控目标过小；内容超高导致按钮被遮挡；iOS 底部安全区与软键盘遮挡输入框/按钮。
- 建议（写入规格书即可验收）：
  - 为移动端增加最小可用性约束：触控目标尺寸（例如 ≥ 40px）、内容可滚动、底部按钮不被安全区遮挡（safe-area）、输入框聚焦时布局不遮挡确认/取消。
  - 对输入框解析补一个“确认/应用”按钮（不要只依赖 Enter），并在测试计划加入对应项。

### P1-4 新增配置项未与 UI/逻辑闭环（且与 allowPastDates 映射不清）

- 证据：
  - 配置表包含 `confirmBeforeMove` 与 `allowMoveToPast`。`SPEC.md:192`
  - 但设置界面设计（9.1）未包含这两项；同时 DatePickerOptions 里有 `allowPastDates`，但未定义其由哪个设置驱动、F5/F6 是否共用同一规则。`SPEC.md:165`
- 影响：
  - 实现者无法从规格书得出明确映射；验收时也缺少可操作入口。
- 建议：
  - 明确：`allowMoveToPast` → 仅影响 F6（移动目标日期）；`DatePickerOptions.allowPastDates` 的取值来源要写清楚（由 `allowMoveToPast` 决定，或独立设置）。
  - 在设置 UI 设计与测试计划补齐这两项的验收口径（默认值、文案、开关效果）。

### P2-1 术语/用例一致性小问题

- 证据：
  - 快捷选项写“下周末”，但计算逻辑与后文示例指向“下周六”。`SPEC.md:145`
  - 测试用例写 `Ctrl+Enter`，而需求写 `Ctrl/Cmd+Enter`。`SPEC.md:1156`
- 建议：
  - 统一文案与用例，以免产生实现偏差。

### P2-2 移动端测试计划过粗（缺少 F5/F6/DatePicker 的关键路径验收）

- 证据：
  - 7.4 移动端仅笼统描述“Modal 显示效果”。`SPEC.md:1184`
- 建议（最小补齐）：
  - 在 7.4 增加：F5 打开弹窗→输入→选择日期→写入成功提示；F6 点击 📅→选择日期→移动成功/失败提示；DatePicker 日历选择/快捷按钮/输入解析在 iOS/Android 的可用性。

## 建议的规格书修订清单（面向 v1.3.0 开发前）

1. 更新 §6.3 合规：将 F5/F6 写入纳入“有限写入”声明，并补齐失败/撤销/回滚口径。`SPEC.md:1125`
2. 补齐 F6 的一致性与回滚定义，覆盖“目标成功但源失败”的情况，并落到测试用例。`SPEC.md:116`
3. 明确移动端等价交互：右键=桌面端；移动端以按钮/长按为主。`SPEC.md:120`
4. 为 DatePicker 增加移动端可用性约束与验收项（触控目标、安全区、键盘遮挡、确认按钮）。`SPEC.md:141`
5. 配置项闭环：为 `confirmBeforeMove`/`allowMoveToPast` 增加设置 UI 与映射说明，并写入 7.2/7.4 用例。`SPEC.md:176`

